
<!-- https://github.com/mrdoob/three.js/blob/master/examples/webgl_lines_dashed.html

Trying to use that as sort of a style guide.
 -->


<!DOCTYPE html>
<html>
	<head>
		<title>3DGlobe</title>
		<style type="text/css">
			html, body {margin: 0; padding: 0; overflow: hidden;}
		</style>
	</head>
	<body>
		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/OrbitControls.js"></script>
		<script type="text/javascript" src="js/Tween.js"></script>
		<script language="javascript" type="text/javascript" src="geocentric.js"></script>
		<script language="javascript" type="text/javascript" src="jsonloader.js"></script>
		<script type="text/javascript">

		var renderer, scene, camera, controls,
			width = window.innerWidth,
			height = window.innerHeight,
			coastlines;

		var objects = [];

		//introtween
		var position = {
			scale: 0,
			rotation: 0
		};
		var target = {
			scale: 1,
			rotation: (Math.PI*2) * 4
		};
		var tween = new TWEEN.Tween(position).to(target, 2000);
		//tween.delay(500);
		tween.onUpdate(function(){
			//console.log(objects.length);
			for(var object = 0; object < objects.length; object++){
				//console.log(object);
				objects[object].rotateX = position.rotation;
				var scale = position.scale;
				// scale = new THREE.Vector3(scale, scale, scale);
				objects[object].scale.set(scale, scale, scale);// = scale;
			}
		});



		fetchJSONFile('geodata/coastlines.geojson', function(data){
		    coastlines = data.features;
		    console.log("geoJSON loaded\ncalculating geocentric coordinates");

	    	theEllipsoid = new Ellipsoid();
	
			for(var feature = 0; feature < coastlines.length; feature++){
				var geometry = coastlines[feature].geometry.coordinates;
				for(var pair = 0; pair < geometry.length; pair += 1){
					var lat = geometry[pair][1];
					var lon = geometry[pair][0];
					var coordinates = theEllipsoid.getGeocentric(lat, lon, 0);
					for(var i = 0; i < coordinates.length; i++){
						coordinates[i] = map(coordinates[i], 0, theEllipsoid.a, 0, 150); //THIS MAGIC NUMBER??? What's a suitable scale in three.js?
					}
					geometry[pair][0] = coordinates[0];
					geometry[pair][1] = coordinates[1];
					geometry[pair][2] = coordinates[2];
				}
			}

		    init();

		});

		function transformMultiPolygon(features){

		}

		function init(){
			renderer = new THREE.WebGLRenderer();
			renderer.setSize(width, height);
			document.body.appendChild(renderer.domElement);

			camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);

			camera.position.set(0, 0, 500);
			//camera.lookAt(new THREE.Vector3(0, 0, 0));

			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.addEventListener('change', render);
			controls.enablePan = false;
			controls.enableDamping = true;
			controls.minDistance = 200;
			controls.maxDistance = 700;
			controls.rotateSpeed = 0.1;

			scene = new THREE.Scene();
			scene.fog = new THREE.FogExp2(0x000000, 0.0025);

			var material = new THREE.LineBasicMaterial({color: 0xffffff});

			// coastline coordinates to three.js lines
			for(var feature = 0; feature < coastlines.length; feature++){
				var coordinates = coastlines[feature].geometry.coordinates;
				var geometry = new THREE.Geometry();
					for(var i = 0; i < coordinates.length; i+=1){
						var x = coordinates[i][0];
						var y = coordinates[i][1];
						var z = coordinates[i][2];
						geometry.vertices.push(new THREE.Vector3(x, y, z));
					}
				var line = new THREE.Line(geometry, material);

				line.rotateX(-(Math.PI / 2));

				objects.push(line);
				scene.add(line);
			}

			console.log(objects.length);

			tween.start();
			animate();		
		}

		function animate(){

			render();

			requestAnimationFrame(animate);

			controls.update();
			//movement stuff

			TWEEN.update();

			
		}

		function render(){
			renderer.render(scene, camera);
		}

		function test(s){
			for(var object = 0; object < objects.length; object++){
				console.log(s);
				objects[object].scale.set(0, 0, 0);// =  new THREE.Vector3(s, s, s);
			}
		}


		</script>
	</body> 
</html>